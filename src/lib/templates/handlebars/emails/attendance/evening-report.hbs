{{#base headerTitle="Daily Attendance Evening Report" headerSubtitle="Comprehensive performance summary for {{reportDate}}"}}

<div class="greeting">
    Good evening {{recipientName}}! üìä
</div>

<div class="message">
    <p>Here's your comprehensive daily attendance summary for <strong>{{reportDate}}</strong>. This report provides detailed employee performance metrics and comparisons with yesterday's data, generated 30 minutes after the standard close time ({{organizationCloseTime}}).</p>
    
    <!-- CSV File Availability Notice -->
    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6; padding: 16px; margin: 16px 0; border-radius: 8px;">
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <span style="color: #1e40af; font-weight: bold; margin-right: 8px;">üìä</span>
            <span style="font-weight: 700; color: #1e40af; font-size: 16px;">Detailed CSV Report Available</span>
        </div>
        <p style="color: #1e3a8a; margin: 0; font-size: 14px; line-height: 1.5;">
            A comprehensive CSV file containing all employee metrics, performance data, and detailed analytics has been generated and attached to this email. 
            <strong>Open the attached CSV file for in-depth analysis, filtering, and data manipulation.</strong> 
            The CSV includes all employee details, daily metrics, wellness scores, productivity data, and comparative analytics that you can import into Excel or your preferred data analysis tool.
        </p>
        <div style="margin-top: 12px; padding: 8px 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border: 1px dashed #3b82f6;">
            <span style="color: #1e40af; font-size: 13px; font-weight: 600;">üìé Attachment: evening-attendance-report-{{reportDate}}.csv</span>
        </div>
    </div>
</div>

<!-- Daily Overview Summary -->
<div class="info-card">
    <h3>üìà Daily Overview</h3>
    <div class="detail-grid">
        <div class="detail-item">
            <span class="detail-label">Total Employees</span>
            <span class="detail-value">{{totalEmployees}}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Worked Today</span>
            <span class="detail-value" style="color: #22c55e; font-weight: 600;">{{workedTodayCount}}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Total Hours</span>
            <span class="detail-value" style="font-weight: 700; color: #7c2d92;">{{totalHoursWorked}}h</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Average Hours</span>
            <span class="detail-value" style="font-weight: 700; color: #7c2d92;">{{averageHoursWorked}}h</span>
        </div>
    </div>
</div>

<!-- Performance Comparison -->
<div class="info-card">
    <h3>üìä Performance vs Yesterday</h3>
    <div class="detail-grid">
        <div class="detail-item">
            <span class="detail-label">Attendance Change</span>
            <span class="detail-value" style="color: {{#if (gte attendanceChange 0)}}#22c55e{{else}}#ef4444{{/if}}; font-weight: 600;">
                {{#if (gte attendanceChange 0)}}+{{/if}}{{attendanceChange}}%
            </span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Hours Change</span>
            <span class="detail-value" style="color: {{#if (gte hoursChange 0)}}#22c55e{{else}}#ef4444{{/if}}; font-weight: 600;">
                {{#if (gte hoursChange 0)}}+{{/if}}{{hoursChange}}h
            </span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Punctuality Change</span>
            <span class="detail-value" style="color: {{#if (gte punctualityChange 0)}}#22c55e{{else}}#ef4444{{/if}}; font-weight: 600;">
                {{#if (gte punctualityChange 0)}}+{{/if}}{{punctualityChange}}%
            </span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Performance Trend</span>
            <span class="detail-value" style="font-weight: 700; color: {{#if (eq performanceTrend 'improving')}}#22c55e{{else if (eq performanceTrend 'stable')}}#f59e0b{{else}}#ef4444{{/if}};">
                {{#if (eq performanceTrend 'improving')}}üìà{{else if (eq performanceTrend 'stable')}}‚û°Ô∏è{{else}}üìâ{{/if}} {{performanceTrend}}
            </span>
        </div>
    </div>
</div>

<!-- Employee Performance Table - Responsive Design -->
<div class="info-card">
    <h3>üë• Individual Performance Summary</h3>
    
    <!-- Mobile-Friendly Employee Cards for smaller screens -->
    <div style="display: none;" class="mobile-employee-cards">
        {{#each employeeMetrics}}
        <div style="background: {{#if (eq @index 0)}}#fef3c7{{else if (eq status 'Perfect')}}#ecfdf5{{else if (eq status 'Late')}}#fef2f2{{else if (eq status 'Absent')}}#f9fafb{{else}}#ffffff{{/if}}; border-radius: 12px; padding: 16px; margin-bottom: 16px; border-left: 4px solid {{#if (eq status 'Perfect')}}#22c55e{{else if (eq status 'Late')}}#ef4444{{else if (eq status 'Absent')}}#9ca3af{{else}}#f59e0b{{/if}};">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                {{#if avatar}}
                <img src="{{avatar}}" alt="{{name}} {{surname}}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; border: 2px solid {{#if (eq status 'Perfect')}}#22c55e{{else if (eq status 'Late')}}#ef4444{{else if (eq status 'Absent')}}#9ca3af{{else}}#f59e0b{{/if}}; object-fit: cover;">
                {{else}}
                <div style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; border: 2px solid {{#if (eq status 'Perfect')}}#22c55e{{else if (eq status 'Late')}}#ef4444{{else if (eq status 'Absent')}}#9ca3af{{else}}#f59e0b{{/if}}; background: linear-gradient(135deg, {{#if (eq status 'Perfect')}}#22c55e, #16a34a{{else if (eq status 'Late')}}#ef4444, #dc2626{{else if (eq status 'Absent')}}#9ca3af, #6b7280{{else}}#f59e0b, #d97706{{/if}}); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                    {{#if name}}{{substring name 0 1}}{{else}}U{{/if}}{{#if surname}}{{substring surname 0 1}}{{else}}{{/if}}
                </div>
                {{/if}}
                <div>
                    <div style="font-weight: 700; color: #111827; font-size: 16px; margin-bottom: 4px;">{{name}} {{surname}}</div>
                    <div style="font-size: 14px; color: #6b7280;">{{role}}{{#if branch.name}} ‚Ä¢ {{branch.name}}{{/if}}</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                <div>
                    <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Check In</div>
                    <div style="font-weight: 500; color: {{#if isLate}}#dc2626{{else if isEarly}}#059669{{else}}#374151{{/if}};">
                        {{#if checkInTime}}{{checkInTime}}{{else}}--{{/if}}
                    </div>
                    {{#if isLate}}
                        <div style="font-size: 10px; color: #dc2626; font-weight: 500;">{{lateMinutes}}min late</div>
                    {{/if}}
                </div>
                <div>
                    <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Check Out</div>
                    <div style="font-weight: 500; color: #374151;">
                        {{#if checkOutTime}}{{checkOutTime}}{{else if checkInTime}}<em>Working</em>{{else}}--{{/if}}
                    </div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Hours</div>
                    <div style="font-weight: 600; color: {{#if (gte hoursWorked 8)}}#059669{{else if (gte hoursWorked 6)}}#f59e0b{{else}}#dc2626{{/if}};">
                        {{#if hoursWorked}}{{hoursWorked}}h{{else}}0h{{/if}}
                    </div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Status</div>
                    <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; {{#if (eq status 'Perfect')}}background: #d1fae5; color: #065f46;{{else if (eq status 'Early')}}background: #dcfce7; color: #166534;{{else if (eq status 'On Time')}}background: #dbeafe; color: #1e40af;{{else if (eq status 'Late')}}background: #fecaca; color: #991b1b;{{else if (eq status 'Absent')}}background: #f3f4f6; color: #6b7280;{{else}}background: #fef3c7; color: #92400e;{{/if}}">
                        {{status}}
                    </span>
                </div>
            </div>
            
            {{#if yesterdayComparison}}
            <div style="border-top: 1px solid #e5e7eb; padding-top: 8px;">
                <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">vs Yesterday</div>
                <div style="font-size: 14px;">
                    <span style="color: {{#if (gte yesterdayComparison.hoursChange 0)}}#059669{{else}}#dc2626{{/if}}; font-weight: 500;">
                        {{#if (gte yesterdayComparison.hoursChange 0)}}+{{/if}}{{yesterdayComparison.hoursChange}}h
                    </span>
                    <span style="margin-left: 12px; color: {{#if (eq yesterdayComparison.punctualityChange 'better')}}#059669{{else if (eq yesterdayComparison.punctualityChange 'same')}}#6b7280{{else}}#dc2626{{/if}}; font-size: 12px;">
                        {{yesterdayComparison.punctualityChange}}
                    </span>
                </div>
            </div>
            {{/if}}
            
            <!-- Enhanced Metrics for Mobile -->
            <div style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px;">
                <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">Daily Performance</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                    <div style="text-align: center;">
                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Visits</div>
                        <div style="font-weight: 600; color: #374151;">
                            {{#if dailyMetrics.visits.completedVisits}}{{dailyMetrics.visits.completedVisits}}{{else}}0{{/if}}/{{#if dailyMetrics.visits.totalVisits}}{{dailyMetrics.visits.totalVisits}}{{else}}0{{/if}}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            {{!-- PRIORITIZE ENHANCED DISTANCE CALCULATION --}}
                            {{#if tracking.tripSummary.totalDistanceKm}}
                                {{tracking.tripSummary.totalDistanceKm}} km
                            {{else if tracking.visits.totalDistance}}
                                {{tracking.visits.totalDistance}}
                            {{else if dailyMetrics.visits.totalDistance}}
                                {{dailyMetrics.visits.totalDistance}}
                            {{else}}
                                0.0 km
                            {{/if}}
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Leads</div>
                        <div style="font-weight: 600; color: #2563eb;">
                            {{#if dailyMetrics.leads.newLeads}}{{dailyMetrics.leads.newLeads}}{{else}}0{{/if}}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">new</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Tasks</div>
                        <div style="font-weight: 600; color: #059669;">
                            {{#if dailyMetrics.tasks.completed}}{{dailyMetrics.tasks.completed}}{{else}}0{{/if}}/{{#if dailyMetrics.tasks.total}}{{dailyMetrics.tasks.total}}{{else}}0{{/if}}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">done</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                    <div style="text-align: center;">
                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Claims</div>
                        <div style="font-weight: 600; color: #374151;">
                            {{#if dailyMetrics.claims.totalClaims}}{{dailyMetrics.claims.totalClaims}}{{else}}0{{/if}}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            {{#if dailyMetrics.claims.totalClaimsValue}}{{dailyMetrics.claims.totalClaimsValue}}{{else}}R 0{{/if}}
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Revenue</div>
                        <div style="font-weight: 600; color: #059669;">
                            {{#if dailyMetrics.sales.totalRevenue}}{{dailyMetrics.sales.totalRevenue}}{{else}}R 0{{/if}}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">earned</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; font-weight: 600;">Wellness</div>
                        <div style="font-weight: 600; color: {{#if (eq dailyMetrics.wellness.stressLevel 'low')}}#059669{{else if (eq dailyMetrics.wellness.stressLevel 'medium')}}#f59e0b{{else}}#dc2626{{/if}};">
                            {{#if dailyMetrics.wellness.wellnessScore}}{{dailyMetrics.wellness.wellnessScore}}{{else}}54{{/if}}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            {{#if dailyMetrics.wellness.stressLevel}}{{dailyMetrics.wellness.stressLevel}}{{else}}low{{/if}} stress
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {{/each}}
    </div>
    
    <!-- Desktop Table -->
    <div class="desktop-table" style="overflow-x: auto; margin-top: 16px;">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px; min-width: 700px;">
            <thead>
                <tr style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-bottom: 2px solid #e2e8f0;">
                    <th style="padding: 16px 12px; text-align: left; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Employee</th>
                    <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Check In</th>
                    <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Check Out</th>
                    <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Hours</th>
                    <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Status</th>
                            <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">vs Yesterday</th>
                            <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Visits</th>
                            <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Distance</th>
                            <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Leads</th>
                            <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Tasks</th>
                            <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Claims</th>
                            <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Revenue</th>
                            <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Efficiency</th>
                            <th style="padding: 16px 12px; text-align: center; font-weight: 700; color: #374151; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Wellness</th>
                </tr>
            </thead>
            <tbody>
                {{#each employeeMetrics}}
                <tr style="border-bottom: 1px solid #e5e7eb; {{#if (eq @index 0)}}background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);{{else if (eq status 'Perfect')}}background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);{{else if (eq status 'Late')}}background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);{{else if (eq status 'Absent')}}background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);{{else}}background: #ffffff;{{/if}} transition: all 0.2s ease;">
                    <td style="padding: 16px 12px;">
                        <div style="display: flex; align-items: center;">
                            {{#if avatar}}
                            <img src="{{avatar}}" alt="{{name}} {{surname}}" style="width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; border: 2px solid {{#if (eq status 'Perfect')}}#22c55e{{else if (eq status 'Late')}}#ef4444{{else if (eq status 'Absent')}}#9ca3af{{else}}#f59e0b{{/if}}; object-fit: cover;">
                            {{else}}
                            <div style="width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; border: 2px solid {{#if (eq status 'Perfect')}}#22c55e{{else if (eq status 'Late')}}#ef4444{{else if (eq status 'Absent')}}#9ca3af{{else}}#f59e0b{{/if}}; background: linear-gradient(135deg, {{#if (eq status 'Perfect')}}#22c55e, #16a34a{{else if (eq status 'Late')}}#ef4444, #dc2626{{else if (eq status 'Absent')}}#9ca3af, #6b7280{{else}}#f59e0b, #d97706{{/if}}); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                {{#if name}}{{substring name 0 1}}{{else}}U{{/if}}{{#if surname}}{{substring surname 0 1}}{{else}}{{/if}}
                            </div>
                            {{/if}}
                            <div>
                                <div style="font-weight: 700; color: #111827; font-size: 15px;">{{name}} {{surname}}</div>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 2px;">{{role}}{{#if branch.name}} ‚Ä¢ {{branch.name}}{{/if}}</div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 16px 12px; text-align: center;">
                        {{#if checkInTime}}
                            <div style="font-weight: 600; color: {{#if isLate}}#dc2626{{else if isEarly}}#059669{{else}}#374151{{/if}}; font-size: 14px;">{{checkInTime}}</div>
                            {{#if isLate}}
                                <div style="font-size: 11px; color: #dc2626; font-weight: 500; margin-top: 2px;">{{lateMinutes}}min late</div>
                            {{/if}}
                        {{else}}
                            <div style="color: #9ca3af; font-style: italic; font-size: 14px;">--</div>
                        {{/if}}
                    </td>
                    <td style="padding: 16px 12px; text-align: center;">
                        {{#if checkOutTime}}
                            <div style="font-weight: 600; color: #374151; font-size: 14px;">{{checkOutTime}}</div>
                        {{else if checkInTime}}
                            <div style="color: #f59e0b; font-style: italic; font-size: 14px; font-weight: 500;">Still Working</div>
                        {{else}}
                            <div style="color: #9ca3af; font-style: italic; font-size: 14px;">--</div>
                        {{/if}}
                    </td>
                    <td style="padding: 16px 12px; text-align: center;">
                        {{#if hoursWorked}}
                            <div style="font-weight: 700; color: {{#if (gte hoursWorked 8)}}#059669{{else if (gte hoursWorked 6)}}#f59e0b{{else}}#dc2626{{/if}}; font-size: 15px;">{{hoursWorked}}h</div>
                        {{else}}
                            <div style="color: #9ca3af; font-size: 14px;">0h</div>
                        {{/if}}
                    </td>
                    <td style="padding: 16px 12px; text-align: center;">
                        <span style="padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; {{#if (eq status 'Perfect')}}background: #d1fae5; color: #065f46;{{else if (eq status 'Early')}}background: #dcfce7; color: #166534;{{else if (eq status 'On Time')}}background: #dbeafe; color: #1e40af;{{else if (eq status 'Late')}}background: #fecaca; color: #991b1b;{{else if (eq status 'Absent')}}background: #f3f4f6; color: #6b7280;{{else}}background: #fef3c7; color: #92400e;{{/if}}">
                            {{status}}
                        </span>
                    </td>
                    <td style="padding: 16px 12px; text-align: center;">
                        {{#if yesterdayComparison}}
                            <div style="font-size: 13px;">
                                <div style="color: {{#if (gte yesterdayComparison.hoursChange 0)}}#059669{{else}}#dc2626{{/if}}; font-weight: 600; margin-bottom: 2px;">
                                    {{#if (gte yesterdayComparison.hoursChange 0)}}+{{/if}}{{yesterdayComparison.hoursChange}}h
                                </div>
                                <div style="color: {{#if (eq yesterdayComparison.punctualityChange 'better')}}#059669{{else if (eq yesterdayComparison.punctualityChange 'same')}}#6b7280{{else}}#dc2626{{/if}}; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    {{yesterdayComparison.punctualityChange}}
                                </div>
                            </div>
                        {{else}}
                            <div style="color: #9ca3af; font-size: 12px; font-style: italic;">No data</div>
                        {{/if}}
                    </td>
                    
                    <!-- New Comprehensive Metrics Columns -->
                    <!-- Visits -->
                    <td style="padding: 16px 12px; text-align: center;">
                        <div style="font-size: 13px;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">
                                {{#if dailyMetrics.visits.completedVisits}}{{dailyMetrics.visits.completedVisits}}{{else}}0{{/if}}/{{#if dailyMetrics.visits.totalVisits}}{{dailyMetrics.visits.totalVisits}}{{else}}0{{/if}}
                            </div>
                            <div style="color: #6b7280; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                visits
                            </div>
                            {{#if dailyMetrics.visits.avgDuration}}
                            <div style="color: #059669; font-size: 11px; font-weight: 500; margin-bottom: 4px;">
                                Avg: {{dailyMetrics.visits.avgDuration}}m
                            </div>
                            {{/if}}
                            {{#if dailyMetrics.visits.topLocations}}
                            <div style="font-size: 10px; color: #6b7280; line-height: 1.2;">
                                {{#each dailyMetrics.visits.topLocations}}
                                {{#if (lt @index 3)}}
                                <div style="margin-bottom: 1px;">{{this}}</div>
                                {{/if}}
                                {{/each}}
                            </div>
                            {{/if}}
                        </div>
                    </td>
                    
                    <!-- Distance - PRIORITIZE ENHANCED CALCULATION -->
                    <td style="padding: 16px 12px; text-align: center;">
                        <div style="font-size: 12px; color: #374151; font-weight: 500;">
                            {{!-- Priority: Enhanced tripSummary > tracking fields > legacy fields --}}
                            {{#if tracking.tripSummary.totalDistanceKm}}
                                {{tracking.tripSummary.totalDistanceKm}} km
                            {{else if tracking.visits.totalDistance}}
                                {{tracking.visits.totalDistance}}
                            {{else if tracking.location.totalDistance}}
                                {{tracking.location.totalDistance}}
                            {{else if dailyMetrics.visits.totalDistance}}
                                {{dailyMetrics.visits.totalDistance}}
                            {{else}}
                                0.0 km
                            {{/if}}
                        </div>
                    </td>
                    
                    <!-- Leads -->
                    <td style="padding: 16px 12px; text-align: center;">
                        <div style="font-size: 13px;">
                            <div style="font-weight: 600; color: #2563eb; margin-bottom: 2px;">
                                {{#if dailyMetrics.leads.newLeads}}{{dailyMetrics.leads.newLeads}}{{else}}0{{/if}}
                            </div>
                            <div style="color: #6b7280; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">
                                new
                            </div>
                        </div>
                    </td>
                    
                    <!-- Tasks -->
                    <td style="padding: 16px 12px; text-align: center;">
                        <div style="font-size: 13px;">
                            <div style="font-weight: 600; color: #059669; margin-bottom: 2px;">
                                {{#if dailyMetrics.tasks.completed}}{{dailyMetrics.tasks.completed}}{{else}}0{{/if}}/{{#if dailyMetrics.tasks.total}}{{dailyMetrics.tasks.total}}{{else}}0{{/if}}
                            </div>
                            <div style="color: #6b7280; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">
                                done
                            </div>
                        </div>
                    </td>
                    
                    <!-- Claims -->
                    <td style="padding: 16px 12px; text-align: center;">
                        <div style="font-size: 13px;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 2px;">
                                {{#if dailyMetrics.claims.totalClaims}}{{dailyMetrics.claims.totalClaims}}{{else}}0{{/if}}
                            </div>
                            <div style="color: #6b7280; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">
                                {{#if dailyMetrics.claims.totalClaimsValue}}{{dailyMetrics.claims.totalClaimsValue}}{{else}}R 0{{/if}}
                            </div>
                        </div>
                    </td>
                    
                    <!-- Revenue -->
                    <td style="padding: 16px 12px; text-align: center;">
                        <div style="font-size: 12px; color: #059669; font-weight: 600;">
                            {{#if dailyMetrics.sales.totalRevenue}}{{dailyMetrics.sales.totalRevenue}}{{else}}R 0{{/if}}
                        </div>
                    </td>
                    
                    <!-- Efficiency -->
                    <td style="padding: 16px 12px; text-align: center;">
                        <div style="font-size: 13px;">
                            <div style="font-weight: 600; color: {{#if (gte dailyMetrics.performance.efficiencyScore 80)}}#059669{{else if (gte dailyMetrics.performance.efficiencyScore 60)}}#f59e0b{{else}}#dc2626{{/if}}; margin-bottom: 2px;">
                                {{#if dailyMetrics.performance.efficiencyScore}}{{dailyMetrics.performance.efficiencyScore}}{{else}}0{{/if}}%
                            </div>
                            <div style="color: #6b7280; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">
                                score
                            </div>
                        </div>
                    </td>
                    
                    <!-- Wellness -->
                    <td style="padding: 16px 12px; text-align: center;">
                        <div style="font-size: 13px;">
                            <div style="font-weight: 600; color: {{#if (eq dailyMetrics.wellness.stressLevel 'low')}}#059669{{else if (eq dailyMetrics.wellness.stressLevel 'medium')}}#f59e0b{{else}}#dc2626{{/if}}; margin-bottom: 2px;">
                                {{#if dailyMetrics.wellness.wellnessScore}}{{dailyMetrics.wellness.wellnessScore}}{{else}}54{{/if}}
                            </div>
                            <div style="color: #6b7280; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">
                                {{#if dailyMetrics.wellness.stressLevel}}{{dailyMetrics.wellness.stressLevel}}{{else}}low{{/if}} stress
                            </div>
                        </div>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
</div>

<!-- Top Performers -->
{{#if topPerformers}}
<div class="success-notice">
    <h4 style="color: #15803d; margin-bottom: 24px;">üèÜ Top Performers Today</h4>
    <div style="display: grid; gap: 20px;">
        {{#each topPerformers}}
        <div style="display: flex; align-items: center; padding: 20px; background: rgba(34, 197, 94, 0.1); border-radius: 12px; border-left: 4px solid #22c55e; margin-bottom: 8px;">
            <div style="flex: 1; padding-right: 16px;">
                <div style="font-weight: 700; color: #15803d; font-size: 16px; margin-bottom: 6px;">{{name}} {{surname}} {{hoursWorked}}h</div>
                <div style="font-size: 14px; color: #16a34a; line-height: 1.4;">{{achievement}}</div>
            </div>
            <div style="text-align: right; background: rgba(34, 197, 94, 0.15); padding: 12px; border-radius: 8px; min-width: 80px;">
                <div style="font-size: 12px; color: #16a34a; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">{{metric}}</div>
            </div>
        </div>
        {{/each}}
    </div>
</div>
{{/if}}

<!-- Areas for Improvement -->
{{#if improvementAreas}}
<div class="warning-notice">
    <h4 style="color: #92400e; margin-bottom: 16px;">üìà Areas for Improvement</h4>
    <div style="display: grid; gap: 12px;">
        {{#each improvementAreas}}
        <div style="display: flex; align-items: center; padding: 16px; background: rgba(245, 158, 11, 0.1); border-radius: 12px; border-left: 4px solid #f59e0b;">
            <div style="flex: 1;">
                <div style="font-weight: 700; color: #92400e; font-size: 15px;">{{area}}</div>
                <div style="font-size: 14px; color: #d97706; margin-top: 2px;">{{description}}</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 13px; color: #d97706; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">{{count}} employees</div>
            </div>
        </div>
        {{/each}}
    </div>
</div>
{{/if}}

<!-- Lateness Summary -->
{{#if latenessSummary.totalLateEmployees}}
<div class="warning-notice">
    <h4 style="color: #d97706; margin-bottom: 16px;">üìä Daily Lateness Summary</h4>
    <div class="detail-grid">
        <div class="detail-item">
            <span class="detail-label">Late Employees Today</span>
            <span class="detail-value" style="color: #dc2626; font-weight: 700;">{{latenessSummary.totalLateEmployees}}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Total Late Minutes</span>
            <span class="detail-value" style="color: #dc2626; font-weight: 700;">{{latenessSummary.totalLateMinutes}}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Average Late Minutes</span>
            <span class="detail-value" style="color: #dc2626; font-weight: 700;">{{latenessSummary.averageLateMinutes}}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Punctuality Trend</span>
            <span class="detail-value" style="color: {{#if (eq latenessSummary.punctualityTrend 'excellent - no late arrivals')}}#22c55e{{else if (eq latenessSummary.punctualityTrend 'good - minimal late arrivals')}}#16a34a{{else if (eq latenessSummary.punctualityTrend 'concerning - moderate late arrivals')}}#f59e0b{{else}}#dc2626{{/if}}; font-weight: 700; text-transform: capitalize;">{{latenessSummary.punctualityTrend}}</span>
        </div>
    </div>
</div>
{{/if}}

<!-- Key Insights -->
<div class="info-card">
    <h4>üí° Key Insights & Performance Trends</h4>
    <div class="feature-list" style="list-style: none; padding: 0; margin: 16px 0;">
        <li style="padding: 12px 0; color: #4b5563; padding-left: 35px; position: relative; font-size: 15px; line-height: 1.6; border-bottom: 1px solid rgba(168, 85, 247, 0.1);">
            <span style="position: absolute; left: 0; top: 12px; color: #7c2d92; font-weight: bold; font-size: 16px;">üìä</span>
            <strong>Overall Performance:</strong> {{overallPerformance.description}}
        </li>
        <li style="padding: 12px 0; color: #4b5563; padding-left: 35px; position: relative; font-size: 15px; line-height: 1.6; border-bottom: 1px solid rgba(168, 85, 247, 0.1);">
            <span style="position: absolute; left: 0; top: 12px; color: #7c2d92; font-weight: bold; font-size: 16px;">üë•</span>
            <strong>Attendance Rate:</strong> {{attendanceRate}}%{{#if yesterdayAttendanceRate}} ({{#if (gte attendanceChange 0)}}improved{{else}}decreased{{/if}} from {{yesterdayAttendanceRate}}% yesterday){{/if}}
        </li>
        <li style="padding: 12px 0; color: #4b5563; padding-left: 35px; position: relative; font-size: 15px; line-height: 1.6; border-bottom: 1px solid rgba(168, 85, 247, 0.1);">
            <span style="position: absolute; left: 0; top: 12px; color: #7c2d92; font-weight: bold; font-size: 16px;">‚è±Ô∏è</span>
            <strong>Productivity:</strong> Average {{averageHoursWorked}} hours per employee{{#if (gte averageHoursWorked 8)}} - excellent commitment{{else if (gte averageHoursWorked 6)}} - good performance{{else}} - needs attention{{/if}}
        </li>
        <li style="padding: 12px 0; color: #4b5563; padding-left: 35px; position: relative; font-size: 15px; line-height: 1.6; border-bottom: 1px solid rgba(168, 85, 247, 0.1);">
            <span style="position: absolute; left: 0; top: 12px; color: #7c2d92; font-weight: bold; font-size: 16px;">üéØ</span>
            <strong>Punctuality:</strong> {{punctualityRate}}% arrived on time{{#if (gte punctualityRate 90)}} - outstanding{{else if (gte punctualityRate 75)}} - good{{else}} - requires focus{{/if}}
        </li>
        {{#if departmentInsights}}
        <li style="padding: 12px 0; color: #4b5563; padding-left: 35px; position: relative; font-size: 15px; line-height: 1.6;">
            <span style="position: absolute; left: 0; top: 12px; color: #7c2d92; font-weight: bold; font-size: 16px;">üè¢</span>
            <strong>Department Focus:</strong> {{departmentInsights}}
        </li>
        {{/if}}
    </div>
</div>

<!-- Tomorrow's Action Items -->
<div class="info-card">
    <h4>üéØ Tomorrow's Action Plan</h4>
    <div class="feature-list" style="list-style: none; padding: 0; margin: 16px 0;">
        {{#each tomorrowActions}}
        <li style="padding: 12px 0; color: #4b5563; padding-left: 35px; position: relative; font-size: 15px; line-height: 1.6; {{#unless @last}}border-bottom: 1px solid rgba(168, 85, 247, 0.1);{{/unless}}">
            <span style="position: absolute; left: 0; top: 12px; color: #22c55e; font-weight: bold; font-size: 14px; width: 20px; height: 20px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">‚úì</span>
            {{this}}
        </li>
        {{/each}}
    </div>
</div>

<style>
    @media (max-width: 768px) {
        .desktop-table {
            display: none !important;
        }
        .mobile-employee-cards {
            display: block !important;
        }
    }
    
    @media (min-width: 769px) {
        .mobile-employee-cards {
            display: none !important;
        }
        .desktop-table {
            display: block !important;
        }
    }
</style>

{{/base}} 